---
Test
---

!2 Test Lagre loggmelding via Kafka

!include SetupServer


!3 1. Lag en loggmelding som består av angitt tekst pluss timestamp, så den blir unik

| !- Query:no.nav.sporingslogg.web.fitnesse.EncodeMessage -! | !- Dette er meldingen -! |
| Dummykey | Melding   | Encodedstring  |
| 1        | $melding= | $encoded=      |


!3 2. Legg den B64-encodede loggmeldingen på angitt Kafka topic

| script | no.nav.sporingslogg.web.fitnesse.ExternKafkaProducerFixture  | aapen-sporingslogg-loggmeldingMottatt |
| produce | !- {"person":"srvABACPEP", "mottaker":"123456789", "tema":"ABC", "behandlingsGrunnlag":"hjemmel1", "uthentingsTidspunkt":"2019-08-16T12:24:21.675", "leverteData":"$encoded", "dataForespørsel":"jeg vil se alt", "leverandør":"333222111"} -! |


!3 3. Vent litt så meldingen blir tatt og prosessert

| script | no.nav.sporingslogg.web.fitnesse.SleepFixture  |
| sleep seconds | 1 |


!3 4. NB SATT OPP MOT T4: Les innhold i databasen, sjekk at loggmeldingen er lagret der med forventede verdier

For ID vet vi ikke hvilken verdi vi forventer, bare at det er lagret en verdi
!define ikke_blank {=~/$/}

| !- Query:no.nav.sporingslogg.web.fitnesse.LesDatabaseTabell_T4 -! | SPORINGS_LOGG | !- WHERE PERSON = '12345678901' AND DBMS_LOB.substr(LEVERTE_DATA, 300) = '$encoded' -!|
| ID            | PERSON      | MOTTAKER  | TEMA | HJEMMEL  | TIDSPUNKT               | LEVERTE_DATA             |
| ${ikke_blank} | srvABACPEP | 123456789 | ABC  | hjemmel1 | 2019-08-16 12:24:21.675 | $encoded |
