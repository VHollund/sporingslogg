---
Test
---

!2 Test Lagre loggmelding via REST-API, les tilbake

!include SetupServer

!3 1. Legg loggmelding på Kafka topic

Meldingen 'Dette er meldingen' sendes som Base64-encodet tekst: 'RGV0dGUgZXIgbWVsZGluZ2Vu', på topic 'aapen-sporingslogg-loggmeldingMottatt'

| script | no.nav.sporingslogg.web.fitnesse.ExternKafkaProducerFixture  | aapen-sporingslogg-loggmeldingMottatt |
| produce | !- {"person":"12345678901", "mottaker":"123456789", "tema":"ABC", "behandlingsGrunnlag":"hjemmel1", "uthentingsTidspunkt":"2018-10-19T12:24:21.675", "leverteData":"RGV0dGUgZXIgbWVsZGluZ2Vu"} -! |


!3 2. Vent litt så meldingen blir tatt og prosessert

| script | no.nav.sporingslogg.web.fitnesse.SleepFixture  |
| sleep seconds | 1 |


!3 3. Kall REST-tjenesten for å lese loggmelding, sjekk at returnert innhold er det som ble lagret (oidctoken må lages for bruker 12345678901)

For REST-STS i test kan token hentes ved GET til https://security-token-service-t10.nais.preprod.local/rest/v1/sts/token?grant_type=client_credentials&scope=openid
med basic auth for bruker ('Basic c3J2QUJBQ1BFUDpoVUsxLjMwc0tocXAwLigy' for 12345678901)

| !- Table:no.nav.sporingslogg.web.fitnesse.ServerRestFixture -! |
| oidctoken | eyJraWQiOiIyYzIyZTUwNC04YmRhLTRjZmItOGU0Ny1iNDM2NmI3OThkMDAiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJzcnZBQkFDUEVQIiwiYXVkIjpbInNydkFCQUNQRVAiLCJwcmVwcm9kLmxvY2FsIl0sInZlciI6IjEuMCIsIm5iZiI6MTU1OTAzOTk0NiwiYXpwIjoic3J2QUJBQ1BFUCIsImlkZW50VHlwZSI6IlN5c3RlbXJlc3N1cnMiLCJhdXRoX3RpbWUiOjE1NTkwMzk5NDYsImlzcyI6Imh0dHBzOlwvXC9zZWN1cml0eS10b2tlbi1zZXJ2aWNlLXQxMC5uYWlzLnByZXByb2QubG9jYWwiLCJleHAiOjE1NTkwNDM1NDYsImlhdCI6MTU1OTAzOTk0NiwianRpIjoiNGU1OWY5YzgtNGY4Ni00ZTViLTg3OTgtMGJjZDJmNmFjNzIwIn0.g72JKPhpRmjJSCppBmm_DsEt-vghChA6Mt-n4Q0UZa6ofzj7wrm5qfsEHLEkO53GoMA_2m71xyNfi9ekfaKTLkaFBabqlfO7qtcN16N3SuSuiZ-XsEMmPt6qkr8y506U-_QfNp6w5d1CqDCiwCYKvXTT7kzIuRevcC23o0qwJT-vukG4UeXSnvwAOd15o9qKBxhEERuduNkQ1KcRsYyh0zA8U8EVg04L-qjbFG1-r3nwTkHiLW1WvSYE-STnDffclqjBgMvsMM2d6WViRP5-tsf2N0IzM8uoHxoreuFv99jlgXytffRatOvVJ43FJJP2RsHIEG8s9FgLOpNFHZUASQ |
| GET | /sporingslogg/api/les | 200 | Content-Type : application/json  |!- 
 jsonbody[0].person === "12345678901"
 jsonbody[0].mottaker === "123456789"
 jsonbody[0].tema === "ABC"
 jsonbody[0].behandlingsGrunnlag === "hjemmel1"
 jsonbody[0].uthentingsTidspunkt === "2018-10-19T12:24:21"
 jsonbody[0].leverteData === "RGV0dGUgZXIgbWVsZGluZ2Vu"
 -! | 
