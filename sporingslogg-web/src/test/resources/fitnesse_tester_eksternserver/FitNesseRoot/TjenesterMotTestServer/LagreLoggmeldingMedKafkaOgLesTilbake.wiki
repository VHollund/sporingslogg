---
Test
---

!2 Test Lagre loggmelding via REST-API, les tilbake

!include SetupServer

!3 1. Legg loggmelding på Kafka topic

Meldingen 'Dette er meldingen' sendes som Base64-encodet tekst: 'RGV0dGUgZXIgbWVsZGluZ2Vu', på topic 'aapen-sporingslogg-loggmeldingMottatt'

| script | no.nav.sporingslogg.web.fitnesse.ExternKafkaProducerFixture  | aapen-sporingslogg-loggmeldingMottatt |
| produce | !- {"person":"12345678901", "mottaker":"123456789", "tema":"ABC", "behandlingsGrunnlag":"hjemmel1", "uthentingsTidspunkt":"2018-10-19T12:24:21.675", "leverteData":"RGV0dGUgZXIgbWVsZGluZ2Vu"} -! |


!3 2. Vent litt så meldingen blir tatt og prosessert

| script | no.nav.sporingslogg.web.fitnesse.SleepFixture  |
| sleep seconds | 1 |


!3 3. Kall REST-tjenesten for å lese loggmelding, sjekk at returnert innhold er det som ble lagret (oidctoken må lages for bruker 12345678901)

For REST-STS i test kan token hentes ved GET til https://security-token-service-t4.nais.preprod.local/rest/v1/sts/token?grant_type=client_credentials&scope=openid
med basic auth for bruker ('Basic c3J2QUJBQ1BFUDpoVUsxLjMwc0tocXAwLigy' for 12345678901)

| !- Table:no.nav.sporingslogg.web.fitnesse.ServerRestFixture -! |
| oidctoken | eyJraWQiOiI2MDdmNzFhMS01YjRiLTQ0YzQtYjgwZi1mN2EwZDRjODVhNWMiLCJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJzcnZBQkFDUEVQIiwiYXVkIjpbInNydkFCQUNQRVAiLCJwcmVwcm9kLmxvY2FsIl0sInZlciI6IjEuMCIsIm5iZiI6MTU2NTk0MzQ5OCwiYXpwIjoic3J2QUJBQ1BFUCIsImlkZW50VHlwZSI6IlN5c3RlbXJlc3N1cnMiLCJhdXRoX3RpbWUiOjE1NjU5NDM0OTgsImlzcyI6Imh0dHBzOlwvXC9zZWN1cml0eS10b2tlbi1zZXJ2aWNlLXQ0Lm5haXMucHJlcHJvZC5sb2NhbCIsImV4cCI6MTU2NTk0NzA5OCwiaWF0IjoxNTY1OTQzNDk4LCJqdGkiOiIxYWM5MDk1Yy1kN2VhLTRmZGUtYjg2NS0wZDMwMWEzMjc0NzMifQ.TfZ93hBEgx00rOQH_zaJsFsN8r1NjASXOT5w7EpfFPusl2n0t2DOEnbVXxNOofEGmGXXjdAa3T006zLspnvDXCH3XTDo459GdKAsOlIUKvWXGq3MBer4R3n1MxhfLBw40u45jXKIRa7vdJRYT7FDICyIj8Y6V2K2z9e3QJGuz7oW8RodaTXxdwrt5YjqUvHL6-l0_T2fcxcZ_laAsTeQDtaB3ImQhdR-pKBLqOOUQ3Pq7V09SYaatE4wC2yWTDhfn7N5-uYJBtG4qw4AOBTt5o9RYTI7PSflaKHJO5-O7SM_kvjhOweIx0wEMvhxLEjQPY7gLfdLsRLSfAkcIykdVA |
| GET | /sporingslogg/api/les | 200 | Content-Type : application/json  |!- 
 jsonbody[0].person === "12345678901"
 jsonbody[0].mottaker === "123456789"
 jsonbody[0].tema === "ABC"
 jsonbody[0].behandlingsGrunnlag === "hjemmel1"
 jsonbody[0].uthentingsTidspunkt === "2018-10-19T12:24:21"
 jsonbody[0].leverteData === "RGV0dGUgZXIgbWVsZGluZ2Vu"
 -! | 
